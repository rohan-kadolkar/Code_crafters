<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <style>
    .admin-header {
      background: linear-gradient(135deg, #434343 0%, #000000 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
    }
    .analytics-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .branch-item {
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .year-badge {
      display: inline-block;
      padding: 8px 15px;
      border-radius: 20px;
      background: #e3f2fd;
      color: #1976d2;
      margin: 5px;
      font-weight: 600;
    }
  </style>
</head>
<body class="bg-light">
  <!-- Navigation -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">üõ†Ô∏è Admin Dashboard</span>
      <div>
        <button class="btn btn-outline-light me-2" onclick="exportReport()">üìä Export Report</button>
        <button class="btn btn-outline-light" onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- Header -->
    <div class="admin-header">
      <h2>System Overview</h2>
      <p class="mb-0">Real-time analytics and student dropout monitoring</p>
    </div>

    <div id="error" class="alert alert-danger d-none"></div>

    <!-- KPI Cards -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          <h2 id="total-students">-</h2>
          <p>Total Students</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
          <h2 id="total-teachers">-</h2>
          <p>Total Teachers</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card danger">
          <h2 id="high-risk-total">-</h2>
          <p>üî¥ High Risk Students</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card warning">
          <h2 id="medium-risk-total">-</h2>
          <p>üü† Medium Risk Students</p>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="row">
      <!-- Left Column: Branch Analytics -->
      <div class="col-md-6">
        <div class="analytics-card">
          <h5 class="mb-3">üìö Branch-wise Distribution</h5>
          <div id="branch-stats">
            <p class="text-center text-muted">Loading branch data...</p>
          </div>
        </div>

        <div class="analytics-card">
          <h5 class="mb-3">üìÖ Year-wise Distribution</h5>
          <div id="year-stats">
            <p class="text-center text-muted">Loading year data...</p>
          </div>
        </div>
      </div>

      <!-- Right Column: Risk Distribution -->
      <div class="col-md-6">
        <div class="analytics-card">
          <h5 class="mb-3">‚ö†Ô∏è Risk Distribution</h5>
          anvas id="riskChart" style="max-height: 300px;"></canvas>
        </div>

        <div class="analytics-card">
          <h5 class="mb-3">üìä System Statistics</h5>
          <table class="table table-bordered">
            <tbody>
              <tr>
                <td><strong>Total Predictions:</strong></td>
                <td id="total-predictions">-</td>
              </tr>
              <tr>
                <td><strong>Average GPA:</strong></td>
                <td id="avg-gpa">-</td>
              </tr>
              <tr>
                <td><strong>Average Attendance:</strong></td>
                <td id="avg-attendance">-</td>
              </tr>
              <tr>
                <td><strong>High Risk Rate:</strong></td>
                <td id="high-risk-rate">-</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Recent High-Risk Students -->
    <div class="analytics-card mt-4">
      <h5 class="mb-3">üö® Recent High-Risk Students (Requires Immediate Attention)</h5>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-dark">
            <tr>
              <th>Student ID</th>
              <th>Name</th>
              <th>Branch</th>
              <th>Year</th>
              <th>Risk Score</th>
              <th>GPA</th>
              <th>Attendance</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="high-risk-list">
            <tr>
              <td colspan="8" class="text-center">Loading high-risk students...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="common.js"></script>
  <script>
    let riskChart = null;

    async function loadDashboard() {
      try {
        const data = await API.get('/admin/dashboard');
        
        if (data.error) {
          showError(data.error);
          return;
        }

        const overview = data.overview || {};
        const riskDist = data.risk_distribution || {};
        const branchStats = data.branch_statistics || [];
        const yearStats = data.year_statistics || [];

        // Update KPIs
        document.getElementById('total-students').textContent = overview.total_students || 0;
        document.getElementById('total-teachers').textContent = overview.total_teachers || 0;
        document.getElementById('high-risk-total').textContent = riskDist['High Risk'] || 0;
        document.getElementById('medium-risk-total').textContent = riskDist['Medium Risk'] || 0;

        // Update statistics
        document.getElementById('total-predictions').textContent = 
          (riskDist['High Risk'] || 0) + (riskDist['Medium Risk'] || 0) + (riskDist['Low Risk'] || 0);
        
        const highRiskRate = overview.total_students > 0 
          ? ((riskDist['High Risk'] || 0) / overview.total_students * 100).toFixed(1) 
          : 0;
        document.getElementById('high-risk-rate').textContent = highRiskRate + '%';

        // Render branch stats
        renderBranchStats(branchStats);

        // Render year stats
        renderYearStats(yearStats);

        // Render risk chart
        renderRiskChart(riskDist);

        // Load high-risk students
        loadHighRiskStudents();

      } catch (e) {
        showError('Failed to load dashboard: ' + e.message);
      }
    }

    function renderBranchStats(branches) {
      const container = document.getElementById('branch-stats');
      if (!branches.length) {
        container.innerHTML = '<p class="text-muted">No branch data available</p>';
        return;
      }

      let html = '';
      branches.forEach(b => {
        const riskPercent = b.total > 0 ? (b.high_risk / b.total * 100).toFixed(1) : 0;
        html += `
          <div class="branch-item">
            <div>
              <strong>${b.branch || 'Unknown'}</strong>
              <p class="mb-0 small text-muted">${b.total} students</p>
            </div>
            <div class="text-end">
              <span class="badge bg-danger">${b.high_risk} High Risk</span>
              <p class="mb-0 small text-muted">${riskPercent}% at risk</p>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    function renderYearStats(years) {
      const container = document.getElementById('year-stats');
      if (!years.length) {
        container.innerHTML = '<p class="text-muted">No year data available</p>';
        return;
      }

      let html = '<div>';
      years.forEach(y => {
        html += `
          <span class="year-badge">
            Year ${y.year}: ${y.total} students (${y.high_risk} at risk)
          </span>
        `;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    function renderRiskChart(riskDist) {
      const ctx = document.getElementById('riskChart').getContext('2d');
      
      if (riskChart) {
        riskChart.destroy();
      }

      riskChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['High Risk', 'Medium Risk', 'Low Risk'],
          datasets: [{
            data: [
              riskDist['High Risk'] || 0,
              riskDist['Medium Risk'] || 0,
              riskDist['Low Risk'] || 0
            ],
            backgroundColor: ['#dc3545', '#ffc107', '#28a745'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    async function loadHighRiskStudents() {
      try {
        const data = await API.get('/admin/students?risk=High Risk&per_page=10');
        const students = data.students || [];

        const tbody = document.getElementById('high-risk-list');
        if (!students.length) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center">No high-risk students found</td></tr>';
          return;
        }

        let html = '';
        students.forEach(s => {
          html += `
            <tr>
              <td>${s.student_id}</td>
              <td>${s.full_name || s.name || 'N/A'}</td>
              <td>${s.branch || '-'}</td>
              <td>${s.year || '-'}</td>
              <td><span class="badge bg-danger">${Format.number(s.dropout_risk_score)}</span></td>
              <td>${Format.number(s.current_semester_gpa)}</td>
              <td>${Format.percentage(s.attendance_percentage)}</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="viewStudent(${s.student_id})">
                  View Details
                </button>
              </td>
            </tr>
          `;
        });
        tbody.innerHTML = html;

      } catch (e) {
        console.error('Error loading high-risk students:', e);
      }
    }

    function viewStudent(studentId) {
      alert(`View student ${studentId} - Detail page coming soon!`);
    }

    function exportReport() {
      alert('Export functionality coming soon!');
      // Later: Implement CSV/PDF export
    }

    window.addEventListener('load', loadDashboard);
  </script>
</body>
</html>