<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teacher Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>
<body class="bg-light">
  <!-- Navigation -->
  <nav class="navbar navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">ðŸ“š Teacher Dashboard</span>
      <div>
        <span class="text-white me-3" id="teacher-name">Loading...</span>
        <button class="btn btn-outline-light" onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- KPI Cards -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card stat-card info">
          <h2 id="total-students">-</h2>
          <p>Total Students</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card danger">
          <h2 id="high-risk">-</h2>
          <p>ðŸ”´ High Risk</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card warning">
          <h2 id="medium-risk">-</h2>
          <p>ðŸŸ  Medium Risk</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card success">
          <h2 id="low-risk">-</h2>
          <p>ðŸŸ¢ Low Risk</p>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h5 class="mb-0">My Students</h5>
          </div>
          <div class="col-md-4">
            <select id="filter" class="form-select" onchange="filterStudents()">
              <option value="all">All Students</option>
              <option value="High Risk">High Risk Only</option>
              <option value="Medium Risk">Medium Risk Only</option>
              <option value="Low Risk">Low Risk Only</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Students Grid -->
    <div id="error" class="alert alert-danger d-none"></div>
    <div id="students-list" class="row g-3"></div>
  </div>

  <!-- Student Detail Modal -->
  <div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          <h5 class="modal-title" id="modal-student-name">Student Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <p><strong>Roll No:</strong> <span id="detail-roll">-</span></p>
              <p><strong>Branch:</strong> <span id="detail-branch">-</span></p>
              <p><strong>Year:</strong> <span id="detail-year">-</span></p>
              <p><strong>GPA:</strong> <span id="detail-gpa">-</span></p>
            </div>
            <div class="col-md-6">
              <p><strong>Attendance:</strong> <span id="detail-attendance">-</span>%</p>
              <p><strong>Risk Level:</strong> <span id="detail-risk" class="badge">-</span></p>
              <p><strong>Risk Score:</strong> <span id="detail-score">-</span></p>
            </div>
          </div>
          <hr>
          <h6>Personalized Recommendations</h6>
          <ul id="detail-recommendations" class="mb-0"></ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Send Message</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="common.js"></script>
  <script>
    const TEACHER_ID = Auth.getUser()?.user_id || 1;
    let allStudents = [];
    let modalInstance;

    async function loadDashboard() {
      try {
        const data = await API.get(`/teachers/${TEACHER_ID}/dashboard`);
        
        if (data.error) {
          showError(data.error);
          return;
        }

        // Update teacher name
        if (data.teacher) {
          document.getElementById('teacher-name').textContent = 
            data.teacher.name || data.teacher.teacher_name || 'Teacher';
        }

        // Update statistics
        const stats = data.statistics || {};
        document.getElementById('total-students').textContent = stats.total_students || 0;
        document.getElementById('high-risk').textContent = stats.high_risk || 0;
        document.getElementById('medium-risk').textContent = stats.medium_risk || 0;
        document.getElementById('low-risk').textContent = stats.low_risk || 0;

        // Store and render students
        allStudents = data.students || [];
        renderStudents(allStudents);

      } catch (e) {
        showError('Failed to load dashboard: ' + e.message);
      }
    }

    function renderStudents(students) {
      const container = document.getElementById('students-list');
      container.innerHTML = '';

      if (!students.length) {
        container.innerHTML = '<div class="col-12"><div class="alert alert-info">No students found</div></div>';
        return;
      }

      students.forEach(s => {
        const risk = s.dropout_risk || 'Unknown';
        const score = RiskUtils.formatScore(s.dropout_risk_score);
        
        const card = document.createElement('div');
        card.className = 'col-md-4';
        card.innerHTML = `
          <div class="card student-card ${RiskUtils.getCardClass(risk)}" onclick="showDetails(${s.student_id})">
            <div class="card-body">
              <h6 class="card-title mb-3">${s.full_name || s.name || 'Student #' + s.student_id}</h6>
              <p class="mb-2"><small><strong>Roll:</strong> ${s.roll_number || '-'}</small></p>
              <p class="mb-2"><small><strong>Branch:</strong> ${s.branch_name || s.branch || '-'}</small></p>
              <p class="mb-2"><small><strong>GPA:</strong> ${Format.number(s.current_semester_gpa)}</small></p>
              <p class="mb-3"><small><strong>Attendance:</strong> ${Format.percentage(s.attendance_percentage)}</small></p>
              <span class="badge ${RiskUtils.getBadgeClass(risk)}">${risk} (${score})</span>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function filterStudents() {
      const val = document.getElementById('filter').value;
      if (val === 'all') {
        renderStudents(allStudents);
      } else {
        const filtered = allStudents.filter(s => s.dropout_risk === val);
        renderStudents(filtered);
      }
    }

    function showDetails(studentId) {
      const s = allStudents.find(x => x.student_id == studentId);
      if (!s) return;

      document.getElementById('modal-student-name').textContent = s.full_name || s.name || 'Student';
      document.getElementById('detail-roll').textContent = s.roll_number || '-';
      document.getElementById('detail-branch').textContent = s.branch_name || s.branch || '-';
      document.getElementById('detail-year').textContent = s.year || '-';
      document.getElementById('detail-gpa').textContent = Format.number(s.current_semester_gpa);
      document.getElementById('detail-attendance').textContent = Format.percentage(s.attendance_percentage);
      
      const risk = s.dropout_risk || 'Unknown';
      const riskEl = document.getElementById('detail-risk');
      riskEl.textContent = risk;
      riskEl.className = 'badge ' + RiskUtils.getBadgeClass(risk);

      document.getElementById('detail-score').textContent = RiskUtils.formatScore(s.dropout_risk_score);

      RecommendationUtils.renderList(s.recommendations, 'detail-recommendations');

      if (!modalInstance) {
        modalInstance = new bootstrap.Modal(document.getElementById('studentModal'));
      }
      modalInstance.show();
    }

    window.addEventListener('load', loadDashboard);
  </script>
</body>
</html>