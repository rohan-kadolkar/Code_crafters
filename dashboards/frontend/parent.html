<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Parent Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <style>
    .parent-header {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
    }
    .child-card {
      cursor: pointer;
      transition: all 0.3s;
      border-left: 5px solid #f093fb;
    }
    .child-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .info-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .contact-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 20px;
      border-radius: 8px;
    }
  </style>
</head>
<body class="bg-light">
  <!-- Navigation -->
  <nav class="navbar navbar-dark" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parent Dashboard</span>
      <button class="btn btn-outline-light" onclick="logout()">Logout</button>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Header -->
    <div class="parent-header">
      <h2>ğŸ‘‹ Welcome, Parent!</h2>
      <p class="mb-0">Monitor your child's academic progress and well-being</p>
    </div>

    <div id="error" class="alert alert-danger d-none"></div>

    <!-- Child Profile -->
    <div class="row">
      <!-- Left Column: Quick Stats -->
      <div class="col-md-4">
        <div class="info-section text-center">
          <h5 class="mb-4">Child Profile</h5>
          <div class="mb-3">
            <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 40px; color: white;">
              ğŸ‘¤
            </div>
            <h4 id="child-name">-</h4>
            <p class="text-muted mb-0" id="child-roll">Roll: -</p>
          </div>
          <hr>
          <p><strong>Branch:</strong> <span id="child-branch">-</span></p>
          <p><strong>Year:</strong> <span id="child-year">-</span></p>
          <p><strong>Semester:</strong> <span id="child-semester">-</span></p>
        </div>

        <!-- Risk Alert -->
        <div class="info-section">
          <h5 class="mb-3">âš ï¸ Risk Status</h5>
          <div class="text-center">
            <span id="risk-badge" class="badge bg-secondary fs-5 mb-3">Loading...</span>
            <p class="mb-0">Risk Score: <span id="risk-score">-</span></p>
          </div>
        </div>

        <!-- Contact Teacher -->
        <div class="contact-box">
          <h6>ğŸ“ Need Help?</h6>
          <p class="mb-2 small">Contact Class Coordinator:</p>
          <p class="mb-0"><strong id="coordinator-name">-</strong></p>
          <button class="btn btn-warning btn-sm mt-2 w-100">Send Message</button>
        </div>
      </div>

      <!-- Right Column: Detailed Performance -->
      <div class="col-md-8">
        <!-- Academic Performance -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">ğŸ“Š Academic Performance</h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-4 mb-3">
                <div class="stat-card info">
                  <h2 id="gpa-value">-</h2>
                  <p>Current GPA</p>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="stat-card warning">
                  <h2 id="attendance-value">-</h2>
                  <p>Attendance %</p>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="stat-card success">
                  <h2 id="credits-value">-</h2>
                  <p>Credits Earned</p>
                </div>
              </div>
            </div>

            <hr>

            <h6 class="mb-3">Subject-wise Performance</h6>
            <div id="subjects-list">
              <p class="text-muted">Loading subject data...</p>
            </div>
          </div>
        </div>

        <!-- Attendance Trend -->
        <div class="card mb-4">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">ğŸ“… Attendance Details</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <p><strong>First Half:</strong> <span id="attendance-first">-</span>%</p>
                <div class="progress">
                  <div class="progress-bar bg-info" id="progress-first" style="width: 0%"></div>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <p><strong>Second Half:</strong> <span id="attendance-second">-</span>%</p>
                <div class="progress">
                  <div class="progress-bar bg-info" id="progress-second" style="width: 0%"></div>
                </div>
              </div>
            </div>
            <p class="mb-0"><strong>Trend:</strong> <span id="attendance-trend" class="badge">-</span></p>
          </div>
        </div>

        <!-- Recommendations -->
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">ğŸ’¡ Teacher Recommendations</h5>
          </div>
          <div class="card-body">
            <div id="recommendations-list">
              <p class="text-muted">Loading recommendations...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="common.js"></script>
  <script>
    const PARENT_ID = Auth.getUser()?.user_id || 1;
    const STUDENT_ID = PARENT_ID; // In real system, link via separate parent table

    async function loadDashboard() {
      try {
        const data = await API.get(`/parents/${PARENT_ID}/child/${STUDENT_ID}`);
        
        if (data.error) {
          showError(data.error);
          return;
        }

        const student = data.student || {};
        const predictions = data.predictions || {};

        // Update child profile
        document.getElementById('child-name').textContent = student.full_name || student.firstname || 'Student';
        document.getElementById('child-roll').textContent = 'Roll: ' + (student.roll_number || '-');
        document.getElementById('child-branch').textContent = student.branch_name || student.branch || '-';
        document.getElementById('child-year').textContent = student.year || '-';
        document.getElementById('child-semester').textContent = student.semester || '-';
        document.getElementById('coordinator-name').textContent = student.class_coordinator || 'Not Assigned';

        // Update risk status
        const risk = predictions.dropout_risk || 'Unknown';
        const riskEl = document.getElementById('risk-badge');
        riskEl.textContent = risk;
        riskEl.className = 'badge fs-5 mb-3 ' + RiskUtils.getBadgeClass(risk);
        document.getElementById('risk-score').textContent = RiskUtils.formatScore(predictions.dropout_risk_score);

        // Update academic metrics
        document.getElementById('gpa-value').textContent = Format.number(student.current_semester_gpa);
        document.getElementById('attendance-value').textContent = Format.percentage(student.attendance_percentage);
        document.getElementById('credits-value').textContent = student.total_credits_completed || '-';

        // Update attendance details
        const firstHalf = student.attendance_first_half || 0;
        const secondHalf = student.attendance_second_half || 0;
        document.getElementById('attendance-first').textContent = Format.number(firstHalf);
        document.getElementById('attendance-second').textContent = Format.number(secondHalf);
        document.getElementById('progress-first').style.width = firstHalf + '%';
        document.getElementById('progress-second').style.width = secondHalf + '%';
        
        const trend = student.attendance_trend || 0;
        const trendEl = document.getElementById('attendance-trend');
        if (trend > 0) {
          trendEl.textContent = 'â†‘ Improving';
          trendEl.className = 'badge bg-success';
        } else if (trend < 0) {
          trendEl.textContent = 'â†“ Declining';
          trendEl.className = 'badge bg-danger';
        } else {
          trendEl.textContent = 'â†’ Stable';
          trendEl.className = 'badge bg-secondary';
        }

        // Load subjects
        loadSubjects(student);

        // Load recommendations
        loadRecommendations(predictions.recommendations);

      } catch (e) {
        showError('Failed to load dashboard: ' + e.message);
      }
    }

    function loadSubjects(student) {
      const container = document.getElementById('subjects-list');
      const subjects = {
        'Chemistry': student.marks_subject_chemistry,
        'Computer Science': student.marks_subject_computer_science || student.marks_subject_computerscience,
        'Electronics': student.marks_subject_electronics,
        'Mathematics': student.marks_subject_mathematics,
        'Physics': student.marks_subject_physics
      };

      let html = '<div class="row">';
      for (const [name, marks] of Object.entries(subjects)) {
        if (marks != null) {
          const status = marks >= 75 ? 'âœ… Excellent' : marks >= 50 ? 'âš ï¸ Good' : 'âŒ Needs Improvement';
          html += `
            <div class="col-md-6 mb-2">
              <p class="mb-1"><strong>${name}:</strong> ${Format.number(marks)}% ${status}</p>
            </div>
          `;
        }
      }
      html += '</div>';

      container.innerHTML = html;
    }

    function loadRecommendations(recommendations) {
      const container = document.getElementById('recommendations-list');
      const recs = RecommendationUtils.parse(recommendations);

      if (!recs.length) {
        container.innerHTML = '<p class="text-muted mb-0">No recommendations at this time. Your child is doing well! ğŸ‰</p>';
        return;
      }

      let html = '<ul class="mb-0">';
      recs.forEach(rec => {
        html += `<li class="mb-2">${rec}</li>`;
      });
      html += '</ul>';

      container.innerHTML = html;
    }

    window.addEventListener('load', loadDashboard);
  </script>
</body>
</html>