<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <style>
    .welcome-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .welcome-banner h2 {
      font-weight: 700;
      margin-bottom: 10px;
    }
    .performance-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.3s;
    }
    .performance-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    .metric-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 700;
      margin: 0 auto 15px;
    }
    .gpa-circle {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .attendance-circle {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }
    .subject-bar {
      margin-bottom: 15px;
    }
    .subject-bar .progress {
      height: 25px;
      border-radius: 10px;
      background: #f0f0f0;
    }
    .subject-bar .progress-bar {
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .recommendation-item {
      background: #f8f9ff;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
    }
    .risk-indicator {
      display: inline-block;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 600;
      font-size: 18px;
    }
    /* ============================================
   Micro-Learning Recommendations
   ============================================ */

    .micro-learning-section {
      margin-top: 2rem;
    }

    .micro-card {
      display: flex;
      align-items: center;
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 1.2rem;
      margin-bottom: 1rem;
      transition: var(--transition);
      cursor: pointer;
    }

    .micro-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--box-shadow-lg);
    }

    .micro-icon {
      font-size: 2.2rem;
      margin-right: 1rem;
      color: var(--primary-color);
    }

    .micro-info h5 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .micro-info p {
      margin: 0;
      font-size: 0.9rem;
      color: var(--muted-text);
    }

    .micro-tags {
      margin-top: 0.4rem;
      display: flex;
      gap: 0.4rem;
    }

    .micro-tag {
      background: var(--primary-color);
      color: white;
      font-size: 0.75rem;
      padding: 0.25rem 0.6rem;
      border-radius: 6px;
    }

    .micro-progress {
      width: 100%;
      margin-top: 0.6rem;
      height: 8px;
      background: #e9ecef;
      border-radius: 6px;
      overflow: hidden;
    }

    .micro-progress-bar {
      height: 100%;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      width: 40%; /* dynamic */
      transition: width 0.5s ease;
    }

    .xp-points {
      margin-left: auto;
      font-weight: 700;
      font-size: 0.9rem;
      background: var(--success-color);
      color: white;
      padding: 0.4rem 0.7rem;
      border-radius: 6px;
    }

  </style>
</head>
<body class="bg-light">
  <!-- Navigation -->
  <nav class="navbar navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">üéì Student Dashboard</span>
      <button class="btn btn-outline-light" onclick="logout()">Logout</button>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Welcome Banner -->
    <div class="welcome-banner">
      <h2 id="student-name">Welcome, Student!</h2>
      <p class="mb-0" id="student-info">Loading your information...</p>
    </div>

    <div id="error" class="alert alert-danger d-none"></div>

    <!-- Main Content -->
    <div class="row">
      <!-- Left Column: Performance Metrics -->
      <div class="col-md-4">
        <!-- GPA Card -->
        <div class="performance-card text-center">
          <h5 class="mb-3">Current Semester GPA</h5>
          <div class="metric-circle gpa-circle" id="gpa-display">-</div>
          <p class="text-muted mb-2">Previous: <span id="prev-gpa">-</span></p>
          <p class="text-muted mb-0">Cumulative: <span id="cum-gpa">-</span></p>
        </div>

        <!-- Attendance Card -->
        <div class="performance-card text-center">
          <h5 class="mb-3">Attendance</h5>
          <div class="metric-circle attendance-circle" id="attendance-display">-</div>
          <p class="text-muted mb-0">Keep it above 75%! üí™</p>
        </div>

        <!-- Risk Status Card -->
        <div class="performance-card text-center">
          <h5 class="mb-3">Dropout Risk Status</h5>
          <div id="risk-status" class="risk-indicator">Loading...</div>
          <p class="text-muted mt-3 mb-0">Risk Score: <span id="risk-score">-</span></p>
        </div>
        <!-- Shared Resources from Teachers -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">üìÇ Shared Resources</h5>
            </div>
            <div class="card-body" id="resources-container">
              <p class="text-muted mb-0">Loading resources...</p>
            </div>
        </div>

      </div>

      <!-- Right Column: Details -->
      <div class="col-md-8">
        <!-- Profile Details -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">üìã Profile Details</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <p><strong>Roll Number:</strong> <span id="roll-number">-</span></p>
                <p><strong>Branch:</strong> <span id="branch">-</span></p>
                <p><strong>Year:</strong> <span id="year">-</span></p>
              </div>
              <div class="col-md-6 mb-3">
                <p><strong>Semester:</strong> <span id="semester">-</span></p>
                <p><strong>Status:</strong> <span id="status" class="badge bg-success">-</span></p>
                <p><strong>Class Coordinator:</strong> <span id="coordinator">-</span></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Subject Performance -->
        <div class="card mb-4">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">üìö Subject Performance</h5>
          </div>
          <div class="card-body" id="subjects-container">
            <p class="text-center text-muted">Loading subject data...</p>
          </div>
        </div>

        <!-- Personalized Recommendations -->
        <div class="micro-learning-section">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-gradient mb-0">üéØ Micro-Learning to Fix Weak Areas</h4>
            <button class="btn btn-primary btn-sm" onclick="loadMicroLearning()">
              Generate Recommendations
            </button>
          </div>
          <div id="micro-learning-container">
            <p class="text-muted mb-0">
              Click ‚ÄúGenerate Recommendations‚Äù to get videos that help improve your weaknesses.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="common.js"></script>
  <script>
    const STUDENT_ID = Auth.getUser()?.user_id || 1;

    async function loadDashboard() {
      try {
        const data = await API.get(`/students/${STUDENT_ID}/dashboard`);
        
        if (data.error) {
          showError(data.error);
          return;
        }

        const student = data.student || {};
        const predictions = data.predictions || {};

        // Update welcome banner
        document.getElementById('student-name').textContent = 
          `Welcome, ${student.full_name || student.firstname || 'Student'}! üëã`;
        document.getElementById('student-info').textContent = 
          `${student.branch_name || student.branch || 'Computer Science'} - Year ${student.year || '-'}`;

        // Update profile details
        document.getElementById('roll-number').textContent = student.roll_number || '-';
        document.getElementById('branch').textContent = student.branch_name || student.branch || '-';
        document.getElementById('year').textContent = student.year || '-';
        document.getElementById('semester').textContent = student.semester || '-';
        document.getElementById('status').textContent = student.status || 'Active';
        document.getElementById('coordinator').textContent = student.class_coordinator || '-';

        // Update GPA
        const gpa = student.current_semester_gpa || 0;
        document.getElementById('gpa-display').textContent = Format.number(gpa);
        document.getElementById('prev-gpa').textContent = Format.number(student.previous_semester_gpa);
        document.getElementById('cum-gpa').textContent = Format.number(student.cumulative_gpa);

        // Update attendance
        const attendance = student.attendance_percentage || 0;
        document.getElementById('attendance-display').textContent = Format.percentage(attendance);

        // Update risk status
        const risk = predictions.dropout_risk || 'Unknown';
        const riskEl = document.getElementById('risk-status');
        riskEl.textContent = risk;
        riskEl.className = 'risk-indicator ' + RiskUtils.getBadgeClass(risk).replace('bg-', 'badge-risk-');
        document.getElementById('risk-score').textContent = RiskUtils.formatScore(predictions.dropout_risk_score);

        // Load subject performance
        loadSubjects(student);

        
        console.log('‚úÖ About to call loadResources');
        // Load shared resources
        loadResources();
        
        // Load recommendations
        loadRecommendations(predictions.recommendations);


      } catch (e) {
        showError('Failed to load dashboard: ' + e.message);
      }
    }

    function loadSubjects(student) {
      const container = document.getElementById('subjects-container');
      const subjects = {
        'Chemistry': student.marks_subject_chemistry,
        'Computer Science': student.marks_subject_computer_science || student.marks_subject_computerscience,
        'Electronics': student.marks_subject_electronics,
        'Mathematics': student.marks_subject_mathematics,
        'Physics': student.marks_subject_physics
      };

      let html = '';
      for (const [name, marks] of Object.entries(subjects)) {
        if (marks != null) {
          const percentage = marks;
          const barClass = percentage >= 75 ? 'bg-success' : percentage >= 50 ? 'bg-warning' : 'bg-danger';
          html += `
            <div class="subject-bar">
              <div class="d-flex justify-content-between mb-1">
                <span><strong>${name}</strong></span>
                <span>${Format.number(percentage)}%</span>
              </div>
              <div class="progress">
                <div class="progress-bar ${barClass}" style="width: ${percentage}%">${Format.number(percentage)}%</div>
              </div>
            </div>
          `;
        }
      }

      container.innerHTML = html || '<p class="text-muted">No subject data available</p>';
    }

    function loadRecommendations(recommendations) {
      const container = document.getElementById('recommendations-container');
      const recs = RecommendationUtils.parse(recommendations);

      if (!recs.length) {
        container.innerHTML = '<p class="text-muted">No recommendations at this time. Keep up the great work! üéâ</p>';
        return;
      }

      let html = '';
      recs.forEach((rec, idx) => {
        html += `
          <div class="recommendation-item">
            <strong>${idx + 1}.</strong> ${rec}
          </div>
        `;
      });

      container.innerHTML = html;
    }

    async function loadResources() {
      const container = document.getElementById('resources-container');
      if (!container) return;

      try {
        const data = await API.get(`/students/${STUDENT_ID}/resources`);
        const resources = data.resources || [];

        if (!resources.length) {
          container.innerHTML = '<p class="text-muted mb-0">No resources shared yet.</p>';
          return;
        }

        let html = '<ul class="list-group">';
        resources.forEach(r => {
          const teacherName = r.teacher_name || `Teacher #${r.teacher_id}`;
          const created = r.created_at ? Format.date(r.created_at) : '';
          const typeBadge = `<span class="badge bg-secondary me-2 text-uppercase">${r.type}</span>`;
          const link = r.url ? `<a href="${r.url}" target="_blank" rel="noopener noreferrer">Open</a>` : '';

          html += `
            <li class="list-group-item">
              <div class="d-flex justify-content-between">
                <div>
                  ${typeBadge}<strong>${r.title}</strong>
                  <div class="text-muted small">By ${teacherName}${created ? ' ‚Ä¢ ' + created : ''}</div>
                  ${r.description ? `<div class="mt-1">${r.description}</div>` : ''}
                </div>
                <div class="text-end">${link}</div>
              </div>
            </li>
          `;
        });
        html += '</ul>';
        container.innerHTML = html;
      } catch (err) {
        console.error(err);
        container.innerHTML = '<p class="text-danger mb-0">Failed to load resources.</p>';
      }
    }

    async function loadMicroLearning() {
      const container = document.getElementById('micro-learning-container');
      if (!container) return;

      container.innerHTML = '<p class="text-muted">Loading personalized videos...</p>';

      try {
        const data = await API.get(`/students/${STUDENT_ID}/micro-learning`);
        const videos = data.videos || [];

        if (!videos.length) {
          container.innerHTML = '<p class="text-muted">No micro-learning suggestions right now.</p>';
          return;
        }

        let html = '';
        videos.forEach(v => {
          const width = Math.min(100, (v.estimated_minutes || 5) * 10); // fake progress
          html += `
            <div class="micro-card" onclick="window.open('${v.url}', '_blank')">
              <div class="micro-icon">üé•</div>
              <div class="micro-info">
                <h5>${v.title}</h5>
                <p>Recommended for your strengths in ${v.tag || 'your subjects'}</p>
                <div class="micro-tags">
                  <span class="micro-tag">${v.estimated_minutes || 5} min</span>
                  ${v.tag ? `<span class="micro-tag">${v.tag}</span>` : ''}
                </div>
                <div class="micro-progress">
                  <div class="micro-progress-bar" style="width: ${width}%;"></div>
                </div>
              </div>
              <div class="xp-points">+${v.xp_points || 50} XP</div>
            </div>
          `;
        });
        container.innerHTML = html;
      } catch (err) {
        console.error(err);
        container.innerHTML = '<p class="text-danger">Failed to load micro-learning videos.</p>';
      }
    }


    window.addEventListener('load', loadDashboard);
  </script>
</body>
</html>